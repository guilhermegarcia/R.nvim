# Session notes — 2026-02-17

## Fork cleanup

- PR #501 (`feat/split-direction-mappings`): closed upstream, feature kept in fork only
- PR #502 (`feat/insert-commented-pipe-chain`): closed upstream, but equivalent landed as **PR #504**
  (TreeSitter-based `insert_commented`, merged 2026-02-09)
- Rebased fork onto upstream/main to pick up PR #504
- `personal/all-features` now = upstream/main + split-direction commit only
- Deleted obsolete branches: `feat/insert-commented-pipe-chain`, `feat/split-direction-mappings`
- Two branches remain: `main` (upstream mirror) and `personal/all-features` (daily driver)

## Bug fix: `\o` returns `character(0)` for patterns with backslashes

**Symptom**: pressing `\o` on a pipe chain like

```r
texte |>
  str_extract_all("\\w+") |>
  unlist()
```

inserts `# character(0)` instead of the extracted words. Code works fine when run manually.

**Root cause** (transport layer):

1. `M.insert` replaces `"` with `\x13` to protect against `cut_json_str` scanning for `"`
2. `send_msg` serializes the Lua table to JSON → each `\` becomes `\\`
3. `cut_json_str` (C) finds string boundaries by scanning for raw `"` — **no JSON unescaping**
4. `unscape_str` (C) only handles `\u0012`/`\u0013`; passes `\\` through unchanged
5. R's parser sees `"\\\\w+"` (4 backslashes) → string `\\w+` (2 backslashes) → regex matching literal `\`, not word chars → no matches → `character(0)`

Full chain: buffer `\\` → Lua `\\` → JSON `\\\\` → `cut_json_str` `\\\\` → `unscape_str` `\\\\` → R parser `\\w+` (wrong)

**Fix** (`lua/r/run.lua`, `M.insert`):

```lua
cmd = cmd:gsub("\\\\", "\\")  -- halve backslashes to compensate for JSON doubling
```

This restores the correct count after the round-trip. Added before the `'`/`"` substitutions.

**Commit**: `bcc2ddd`

**Upstream**: the same bug exists there. PR draft saved at `pr-draft-backslash-fix.md`.
The deeper fix would be in `cut_json_str` (C) to unescape `\\` → `\`, but that requires
recompiling nvimcom. Lua workaround chosen for now.
